import { React, Fragment, useEffect } from "react";
import { useParams } from "react-router-dom";
import { connect } from "react-redux";

import { getPatients } from "../../../redux/actions/patientActions";
import { getPatientLatestStatus } from "../../../redux/actions/statusActions";

import PropTypes from "prop-types";

// MUI
import ErrorIcon from "@mui/icons-material/Error";
import {
  Typography,
  Card,
  CardContent,
  Divider,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
} from "@mui/material";

function QRCodeInfo(props) {
  // TODO : History management to redirect after login
  // TODO : Swap if statement after immigration push

  // if (!props.auth.user.is_doctor) {
  //   // history.pushState();
  //   return (
  //     <Card>
  //       <CardContent>
  //         <Typography variant="h5" align="left" gutterBottom component="div">
  //           You must be logged in as a Doctor to view patient information
  //         </Typography>
  //       </CardContent>
  //     </Card>
  //   );
  // }

  if (!props.auth.user.is_doctor && !props.auth.user.is_immigration_officer) {
    return (
      <Card>
        <CardContent>
          <Typography variant="h5" align="left" gutterBottom component="div">
            You must be logged in as a Doctor or Immigration Officer to view
            patient information
          </Typography>
        </CardContent>
      </Card>
    );
  }

  useEffect(() => {
    props.getPatients();
    props.getPatientLatestStatus(patientId);
  }, [patientId]);

  const { patient_uri } = useParams();

  var patientId;
  try {
    patientId = atob(atob(patient_uri));
    var patient = props.patients.find((patient) => patient.user == patientId);

    if (patient == undefined) {
      throw error;
    }
  } catch (error) {
    return (
      <Card>
        <CardContent>
          <Typography variant="h5" align="left" gutterBottom component="div">
            Invalid Patient URI
          </Typography>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardContent>
        <Typography variant="h5" align="left" gutterBottom component="div">
          {patient.first_name}'s Information
        </Typography>
        <Divider />
        <Typography
          m={3}
          pt={0}
          variant="h5"
          align="left"
          gutterBottom
          component="div"
        >
          Status: {props.status.status}
          {props.status.status === "Infected" && <ErrorIcon />}
        </Typography>
        <Typography m={3} pt={2} variant="h5" align="left">
          <Fragment>
            <TableContainer
              component={Paper}
              sx={{ width: 2 / 3, margin: "auto" }}
            >
              <Table sx={{ minWidth: 650 }} aria-label="simple table">
                <TableHead>
                  <TableRow>
                    <TableCell>First</TableCell>
                    <TableCell>Last</TableCell>
                    <TableCell>Gender</TableCell>
                    <TableCell>DOB</TableCell>
                    <TableCell>Assigned Doctor ID</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  <TableRow
                    key={patient.user}
                    sx={{ "&:last-child td, &:last-child th": { border: 0 } }}
                  >
                    <TableCell>{patient.first_name}</TableCell>
                    <TableCell>{patient.last_name}</TableCell>
                    <TableCell>{patient.gender}</TableCell>
                    <TableCell>{patient.date_of_birth}</TableCell>
                    <TableCell>{patient.doctor}</TableCell>
                  </TableRow>
                </TableBody>
              </Table>
            </TableContainer>
          </Fragment>
        </Typography>
      </CardContent>
    </Card>
  );
}

QRCodeInfo.propTypes = {
  auth: PropTypes.object.isRequired,
};

const mapStateToProps = (state) => ({
  auth: state.authReducer,
  patients: state.patientReducer.patients,
  status: state.statusReducer.latestStatus,
});

export default connect(mapStateToProps, {
  getPatients,
  getPatientLatestStatus,
})(QRCodeInfo);
